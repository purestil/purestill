name: PureStill Auto Post

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # daily UTC

jobs:
  autopost:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3️⃣ Install dependencies (CRITICAL)
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser

      # 4️⃣ Verify feedparser (debug safety)
      - name: Verify feedparser
        run: python - <<EOF
          import feedparser
          print("feedparser installed OK")
        EOF

      # 5️⃣ Fetch new content
      - name: Fetch new content
        run: python fetch_news.py

      # 6️⃣ Generate site
      - name: Generate site
        run: python generate_pages.py

      # 7️⃣ Commit and push (safe)
      - name: Commit and push changes
        run: |
          git config user.name "purestill-bot"
          git config user.email "purestill.official@gmail.com"
          git add data.json site || true
          git diff --cached --quiet || git commit -m "Auto post update"
          git push
